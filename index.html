<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤¢å¹»å¯µç‰©å¤§äº¨ v7.1 - å³æ™‚å­˜æª”ç‰ˆ</title>
  <style>
    :root {
      --bg-color: #f0f4f8;
      --primary-color: #4a90e2;
      --card-bg: #ffffff;
      --text-color: #333;
      --btn-click: #f1c40f;
      --btn-gacha: #9b59b6;
      --btn-slot: #34495e;
      --btn-rebirth: #8e44ad;
      --btn-delete: #e74c3c;
      --btn-gallery: #16a085;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      user-select: none;
    }

    h1 {
      margin-bottom: 10px;
      color: #2c3e50;
      text-align: center;
    }

    /* --- å³ä¸Šè§’åŠŸèƒ½åˆ— --- */
    .top-right-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
      align-items: flex-end;
    }

    .hud-btn {
      background: #e67e22;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 5px rgba(0, 0, 0, 0.2);
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: transform 0.2s;
      font-size: 0.9rem;
    }

    .hud-btn:hover {
      transform: scale(1.05);
    }

    .hud-btn.gallery-btn {
      background: var(--btn-gallery);
    }

    /* --- å‡ç´šæ¨¡å¼åˆ‡æ› --- */
    .upgrade-mode-container {
      background: white;
      padding: 5px;
      border-radius: 20px;
      display: flex;
      gap: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .mode-btn {
      border: none;
      background: transparent;
      padding: 5px 10px;
      border-radius: 15px;
      cursor: pointer;
      font-weight: bold;
      color: #7f8c8d;
    }

    .mode-btn.active {
      background: var(--primary-color);
      color: white;
    }

    /* --- å½ˆå‡ºè¦–çª— (å…±ç”¨) --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(3px);
    }

    .modal-content {
      background: white;
      width: 90%;
      max-width: 500px;
      border-radius: 15px;
      padding: 20px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      position: relative;
      border: 2px solid var(--primary-color);
    }

    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
    }

    /* --- æŠ½è›‹æ©Ÿå•†åº—æ¨£å¼ --- */
    .gacha-shop-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
    }

    .gacha-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #ddd;
      background: #f9f9f9;
      transition: transform 0.2s;
    }

    .gacha-item:hover {
      transform: scale(1.02);
      border-color: var(--primary-color);
    }

    /* ä¸åŒç­‰ç´šçš„é¡è‰² */
    .g-tier-1 {
      border-left: 8px solid #95a5a6;
    }

    /* æ™®é€š */
    .g-tier-2 {
      border-left: 8px solid #2ecc71;
    }

    /* é«˜ç´š */
    .g-tier-3 {
      border-left: 8px solid #3498db;
    }

    /* ç‰¹ç´š */
    .g-tier-4 {
      border-left: 8px solid #f1c40f;
    }

    /* å¤§å¸« */
    .g-tier-5 {
      border-left: 8px solid #e74c3c;
      background: #fff5f5;
    }

    /* é­”ç‹ */
    .gacha-info h4 {
      margin: 0;
      font-size: 1.1rem;
    }

    .gacha-info p {
      margin: 5px 0 0;
      font-size: 0.8rem;
      color: #666;
    }

    .gacha-buy-btn {
      background: var(--btn-gacha);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      min-width: 100px;
    }

    .gacha-buy-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* --- éŠæˆ²ä¸»ä»‹é¢ --- */
    .stats-bar {
      background: var(--card-bg);
      padding: 15px 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 10px;
      z-index: 100;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
      font-size: 1.1rem;
      border-bottom: 4px solid var(--primary-color);
      width: 95%;
      max-width: 900px;
      margin-bottom: 20px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #7f8c8d;
    }

    .stat-value {
      font-weight: bold;
      font-size: 1.2rem;
    }

    #money {
      color: #d35400;
    }

    #gps {
      color: #27ae60;
    }

    #multiplier {
      color: #8e44ad;
    }

    .controls {
      margin: 10px 0 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button.game-btn {
      padding: 12px 15px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.1s;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 120px;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
      color: white;
      position: relative;
    }

    button.game-btn:active {
      transform: translateY(4px);
      box-shadow: none;
    }

    button.game-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      filter: grayscale(1);
    }

    .btn-click {
      background-color: var(--btn-click);
      color: #333 !important;
    }

    .btn-gacha {
      background-color: var(--btn-gacha);
    }

    .btn-slot {
      background-color: var(--btn-slot);
    }

    .btn-rebirth {
      background: linear-gradient(45deg, #8e44ad, #c0392b);
      border: 2px solid #fff;
      box-shadow: 0 0 10px rgba(142, 68, 173, 0.5);
      display: none;
    }

    .btn-reset {
      background-color: #7f8c8d;
      min-width: auto !important;
      font-size: 0.8rem;
      padding: 10px;
    }

    .cost-text {
      font-size: 0.8em;
      opacity: 0.9;
      margin-top: 4px;
      font-weight: normal;
    }

    .pet-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      width: 100%;
      max-width: 1000px;
      padding-bottom: 50px;
    }

    .pet-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
      border-top: 5px solid #ccc;
      transition: transform 0.2s;
      overflow: hidden;
    }

    .pet-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .pet-icon {
      font-size: 2.5rem;
      margin: 5px 0;
    }

    .pet-name {
      font-weight: bold;
      font-size: 1rem;
    }

    .pet-rarity {
      font-size: 0.75rem;
      margin-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .pet-stats {
      font-size: 0.85rem;
      color: #555;
      background: #f8f9fa;
      padding: 3px;
      border-radius: 4px;
      margin: 2px 0;
    }

    .btn-delete-pet {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      background-color: var(--btn-delete);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.6;
      z-index: 10;
    }

    .btn-delete-pet:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .btn-upgrade {
      background-color: var(--primary-color);
      color: white;
      width: 100%;
      margin-top: auto;
      border: none;
      border-radius: 5px;
      padding: 8px 0;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-upgrade:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }

    /* ç¨€æœ‰åº¦é¡è‰² */
    .rarity-common {
      border-color: #95a5a6;
      color: #7f8c8d;
    }

    .rarity-rare {
      border-color: #3498db;
      color: #2980b9;
    }

    .rarity-epic {
      border-color: #9b59b6;
      color: #8e44ad;
    }

    .rarity-legendary {
      border-color: #f1c40f;
      color: #f39c12;
    }

    .rarity-mythical {
      border-color: #e74c3c;
      color: #c0392b;
      animation: glow 2s infinite;
    }

    @keyframes glow {
      0% {
        box-shadow: 0 0 5px #e74c3c;
      }

      50% {
        box-shadow: 0 0 20px #e74c3c;
      }

      100% {
        box-shadow: 0 0 5px #e74c3c;
      }
    }

    /* æµ®å‹•è¨Šæ¯ */
    #message-area {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
      z-index: 3000;
    }

    .show-message {
      opacity: 1 !important;
    }

    /* å­˜æª”æç¤ºå°åœ–ç¤º */
    #save-toast {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(46, 204, 113, 0.9);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
      z-index: 3000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .show-save {
      opacity: 1 !important;
    }

    .full-slots {
      color: #e74c3c;
      font-weight: bold;
    }

    /* åœ–é‘‘ç¶²æ ¼ */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .gallery-item {
      background: #eee;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      opacity: 0.5;
      filter: grayscale(1);
    }

    .gallery-item.collected {
      opacity: 1;
      filter: grayscale(0);
      background: #e8f6f3;
      border: 1px solid #1abc9c;
    }

    .g-icon {
      font-size: 2rem;
    }

    .g-name {
      font-size: 0.7rem;
      margin-top: 5px;
    }
  </style>
</head>

<body>
  <div class="top-right-controls"> <button class="hud-btn" onclick="openModal('ach-modal')"> ğŸ† æˆå°± <span id="ach-badge">0/9</span> </button> <button class="hud-btn gallery-btn" onclick="openModal('gallery-modal')"> ğŸ“˜ åœ–é‘‘ </button>
    <div class="upgrade-mode-container"> <button class="mode-btn active" onclick="setUpgradeMode(1)" id="mode-1">1x</button> <button class="mode-btn" onclick="setUpgradeMode(10)" id="mode-10">10x</button> <button class="mode-btn" onclick="setUpgradeMode('max')" id="mode-max">Max</button> </div>
  </div>
  <h1>ğŸ° å¤¢å¹»å¯µç‰©å¤§äº¨ <small style="font-size:0.4em; color: #7f8c8d;">v7.1 å³æ™‚å­˜æª”</small></h1>
  <div class="stats-bar">
    <div class="stat-item"> <span class="stat-label">ğŸ’° ç¾æœ‰è³‡é‡‘</span> <span class="stat-value" id="money">$0</span> </div>
    <div class="stat-item"> <span class="stat-label">âš¡ æ¯ç§’æ”¶å…¥</span> <span class="stat-value" id="gps">$0</span> </div>
    <div class="stat-item"> <span class="stat-label">ğŸ“¦ æ¬„ä½</span> <span class="stat-value" id="slots">0 / 5</span> </div>
    <div class="stat-item"> <span class="stat-label">ğŸŒ€ è¼ªè¿´å€ç‡</span> <span class="stat-value" id="multiplier">x1.0</span> </div>
  </div>
  <div class="controls"> <button class="game-btn btn-click" onclick="manualClick()"> <span>ğŸ”¨ æ‰‹å‹•æ‰“å·¥</span> <span class="cost-text">ç²å¾— +$<span id="click-val">10</span></span> </button> <button class="game-btn btn-gacha" onclick="openModal('gacha-modal')"> <span>ğŸ° è½‰è›‹å•†åº—</span> <span class="cost-text">äº”å¤§ç­‰ç´š</span> </button> <button class="game-btn btn-slot" id="slotBtn" onclick="buySlot()"> <span>ğŸ“¦ æ“´å……æ¬„ä½</span> <span class="cost-text">èŠ±è²»: $<span id="slot-cost-display">500</span></span> </button> <button class="game-btn btn-rebirth" id="rebirthBtn" onclick="rebirth()"> <span>ğŸŒ€ é€²è¡Œè½‰ç”Ÿ</span> <span class="cost-text">éœ€: $1.0M</span> </button> <button class="game-btn btn-reset" onclick="hardReset()"> <span>ğŸ—‘ï¸ åˆªæª”</span> </button> </div>
  <div id="pet-list" class="pet-container"></div>
  <div id="message-area">è¨Šæ¯æç¤º</div>
  <div id="save-toast">ğŸ’¾ è³‡æ–™å·²è‡ªå‹•å„²å­˜</div>
  <div id="gacha-modal" class="modal-overlay" onclick="closeModal(event, 'gacha-modal')">
    <div class="modal-content"> <span class="close-modal" onclick="document.getElementById('gacha-modal').style.display='none'">&times;</span>
      <h3 style="text-align:center;">ğŸ° é¸æ“‡æŠ½è›‹æ©Ÿå™¨</h3>
      <div class="gacha-shop-list" id="gacha-list-container"> </div>
    </div>
  </div>
  <div id="ach-modal" class="modal-overlay" onclick="closeModal(event, 'ach-modal')">
    <div class="modal-content"> <span class="close-modal" onclick="document.getElementById('ach-modal').style.display='none'">&times;</span>
      <h3>ğŸ† éŠæˆ²æˆå°±</h3>
      <div style="width: 100%; height: 10px; background: #ddd; border-radius: 5px; margin-bottom: 15px; overflow: hidden;">
        <div id="ach-progress-bar" style="height: 100%; background: #2ecc71; width: 0%; transition: width 0.5s;"></div>
      </div>
      <div id="ach-list"></div>
    </div>
  </div>
  <div id="gallery-modal" class="modal-overlay" onclick="closeModal(event, 'gallery-modal')">
    <div class="modal-content"> <span class="close-modal" onclick="document.getElementById('gallery-modal').style.display='none'">&times;</span>
      <h3>ğŸ“˜ å¯µç‰©åœ–é‘‘</h3>
      <p style="font-size: 0.8rem; color: #666;">é€²åº¦ä¸éš¨è½‰ç”Ÿé‡ç½®</p>
      <div id="gallery-grid" class="gallery-grid"></div>
    </div>
  </div>
  <div id="info-modal" class="modal-overlay">
    <div class="modal-content" style="text-align: center;">
      <h2 id="info-title" style="color: #f1c40f;">æ¨™é¡Œ</h2>
      <p id="info-desc" style="font-size: 1.1rem; margin: 20px 0;">å…§å®¹</p> <button class="game-btn btn-click" onclick="document.getElementById('info-modal').style.display='none'" style="margin: 0 auto;">ç¢ºå®š</button>
    </div>
  </div>
  <script>
    // --- éŠæˆ²å¸¸æ•¸ ---
    const RARITY_DATA = {
      common: {
        name: "æ™®é€š",
        color: "rarity-common",
        multiplier: 1
      },
      rare: {
        name: "ç¨€æœ‰",
        color: "rarity-rare",
        multiplier: 5
      },
      epic: {
        name: "å²è©©",
        color: "rarity-epic",
        multiplier: 20
      },
      legendary: {
        name: "å‚³èªª",
        color: "rarity-legendary",
        multiplier: 100
      },
      mythical: {
        name: "ç¥è©±",
        color: "rarity-mythical",
        multiplier: 500
      }
    };

    // äº”å¤§æŠ½è›‹æ©Ÿè¨­å®š
    const GACHA_TIERS = [{
        id: 0,
        name: "æ™®é€šæŠ½è›‹æ©Ÿ",
        class: "g-tier-1",
        cost: 100,
        desc: "é©åˆæ–°æ‰‹ï¼Œæ©Ÿç‡ä¸€èˆ¬ã€‚",
        odds: {
          common: 0.50,
          rare: 0.30,
          epic: 0.15,
          legendary: 0.045,
          mythical: 0.005
        }
      },
      {
        id: 1,
        name: "é«˜ç´šæŠ½è›‹æ©Ÿ",
        class: "g-tier-2",
        cost: 5000,
        desc: "ç¨å¾®å¥½ä¸€é»ï¼Œæ™®é€šæ€ªæ¸›å°‘ã€‚",
        odds: {
          common: 0.25,
          rare: 0.40,
          epic: 0.25,
          legendary: 0.08,
          mythical: 0.02
        }
      },
      {
        id: 2,
        name: "ç‰¹ç´šæŠ½è›‹æ©Ÿ",
        class: "g-tier-3",
        cost: 100000,
        desc: "ä¿åº•ç¨€æœ‰ï¼æ²’æœ‰æ™®é€šæ€ªã€‚",
        odds: {
          common: 0.0,
          rare: 0.30,
          epic: 0.45,
          legendary: 0.20,
          mythical: 0.05
        }
      },
      {
        id: 3,
        name: "å¤§å¸«æŠ½è›‹æ©Ÿ",
        class: "g-tier-4",
        cost: 5000000,
        desc: "å¤§å¸«ä¹‹é¸ï¼Œå²è©©èµ·è·³ï¼",
        odds: {
          common: 0.0,
          rare: 0.0,
          epic: 0.40,
          legendary: 0.45,
          mythical: 0.15
        }
      },
      {
        id: 4,
        name: "é­”ç‹æŠ½è›‹æ©Ÿ",
        class: "g-tier-5",
        cost: 200000000,
        desc: "50% æ©Ÿç‡ç²å¾—ç¥è©±ï¼",
        odds: {
          common: 0.0,
          rare: 0.0,
          epic: 0.0,
          legendary: 0.50,
          mythical: 0.50
        }
      }
    ];

    const PET_NAMES = [
      "å²èŠå§†", "é‡è±¬", "è™è ", "å°é›", "é’è›™",
      "éª·é«", "æˆ°ç‹¼", "å·¨é·¹", "çŸ³é ­äºº", "ç²¾éˆ",
      "ç¨è§’ç¸", "å¸è¡€é¬¼", "ä¹å°¾ç‹", "ç…é·²",
      "ç«é¾", "é³³å‡°", "åˆ©ç¶­å¦", "é­”ç¥", "å‰µä¸–ç¥ç¸"
    ];

    const REBIRTH_THRESHOLD = 1000000;

    // --- æˆå°±å®šç¾© ---
    const ACHIEVEMENTS = [{
        id: 1,
        icon: 'ğŸ’°',
        title: 'ç¬¬ä¸€æ¡¶é‡‘',
        desc: 'ç´¯ç©æ“æœ‰ $1,000',
        check: (g) => g.money >= 1000
      },
      {
        id: 2,
        icon: 'ğŸ¦',
        title: 'ç™¾è¬å¯Œç¿',
        desc: 'ç´¯ç©æ“æœ‰ $1,000,000',
        check: (g) => g.money >= 1000000
      },
      {
        id: 3,
        icon: 'ğŸ“¦',
        title: 'æ”¶è—å®¶',
        desc: 'æ“æœ‰ 10 éš»å¯µç‰©',
        check: (g) => g.pets.length >= 10
      },
      {
        id: 4,
        icon: 'ğŸ°',
        title: 'å¤§åœ°ä¸»',
        desc: 'æ“´å……è‡³ 8 å€‹å¯µç‰©æ¬„ä½',
        check: (g) => g.maxSlots >= 8
      },
      {
        id: 5,
        icon: 'âœ¨',
        title: 'å¹¸é‹å…’',
        desc: 'ç²å¾—ã€Œç¨€æœ‰ã€å¯µç‰©',
        check: (g) => g.collection.includes('ç¨€æœ‰')
      },
      {
        id: 6,
        icon: 'ğŸ‘‘',
        title: 'å‚³èªªé™è‡¨',
        desc: 'ç²å¾—ã€Œå‚³èªªã€å¯µç‰©',
        check: (g) => g.collection.includes('å‚³èªª')
      },
      {
        id: 7,
        icon: 'ğŸ‘¹',
        title: 'ç¥è©±ç¾èº«',
        desc: 'ç²å¾—ã€Œç¥è©±ã€å¯µç‰©',
        check: (g) => g.collection.includes('ç¥è©±')
      },
      {
        id: 8,
        icon: 'ğŸ’ª',
        title: 'åŸ¹è‚²å¤§å¸«',
        desc: 'æ“æœ‰ç­‰ç´š 50 çš„å¯µç‰©',
        check: (g) => g.pets.some(p => p.level >= 50)
      },
      {
        id: 9,
        icon: 'ğŸŒ€',
        title: 'è¼ªè¿´å¤§å¸«',
        desc: 'å®Œæˆ 3 æ¬¡è½‰ç”Ÿ',
        check: (g) => g.rebirthCount >= 3
      }
    ];

    let gameData = {
      money: 0,
      pets: [],
      maxSlots: 5,
      slotCost: 500,
      unlockedAchievements: [],
      hasWon: false,
      rebirthCount: 0,
      moneyMultiplier: 1.0,
      collection: [],
      lastLoginTime: Date.now()
    };

    let upgradeMode = 1;

    // --- åˆå§‹åŒ– ---
    function init() {
      loadGame();

      if (typeof gameData.rebirthCount === 'undefined') gameData.rebirthCount = 0;
      if (typeof gameData.moneyMultiplier === 'undefined') gameData.moneyMultiplier = 1.0;
      if (!gameData.collection) gameData.collection = [];

      // é›¢ç·šæ”¶ç›Š
      if (gameData.lastLoginTime) {
        let now = Date.now();
        let diff = (now - gameData.lastLoginTime) / 1000;
        if (diff > 60) {
          let cps = calculateIncome();
          if (cps > 0) {
            let earned = cps * Math.floor(diff);
            gameData.money += earned;
            showInfoModal("æ­¡è¿å›ä¾†ï¼", `æ‚¨é›¢ç·šäº† ${formatTime(diff)}<br>å¯µç‰©å¹«æ‚¨è³ºäº†ï¼š<br><b style="color:#f1c40f; font-size:1.5rem;">$${formatNumber(earned)}</b>`);
          }
        }
      }

      if (gameData.pets.length === 0) {
        addPet("common", "åˆå¿ƒè€…å²èŠå§†", true);
      }

      renderGachaShop(); // æ¸²æŸ“è½‰è›‹å•†åº—
      renderAchievements();
      renderGallery();
      updateUI();

      // æ¯ç§’ç”¢éŒ¢
      setInterval(() => {
        let income = calculateIncome();
        if (income > 0) {
          gameData.money += income;
          updateHeader();
          checkAchievements();
        }
      }, 1000);

      // UI æ›´æ–°è¿´åœˆ
      setInterval(updateButtons, 200);

      // â˜…â˜…â˜… è‡ªå‹•å­˜æª”æ©Ÿåˆ¶ (æ¯5ç§’) â˜…â˜…â˜…
      setInterval(() => {
        saveGame(true); // true ä»£è¡¨é¡¯ç¤ºæç¤º
      }, 5000);

      // â˜…â˜…â˜… é—œé–‰è¦–çª—å‰å¼·åˆ¶å­˜æª” â˜…â˜…â˜…
      window.addEventListener('beforeunload', () => {
        saveGame(false);
      });
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function calculateIncome() {
      let baseTotal = gameData.pets.reduce((acc, pet) => acc + pet.income, 0);
      return Math.floor(baseTotal * gameData.moneyMultiplier);
    }

    function manualClick() {
      let val = Math.floor(10 * gameData.moneyMultiplier);
      gameData.money += val;
      updateHeader();
      checkAchievements();
      createFloatingText(event.clientX, event.clientY, `+$${formatNumber(val)}`);
    }

    function buySlot() {
      if (gameData.money >= gameData.slotCost) {
        gameData.money -= gameData.slotCost;
        gameData.maxSlots += 1;
        gameData.slotCost = Math.floor(gameData.slotCost * 1.5);
        showMessage(`æ“´å……æˆåŠŸï¼ä¸Šé™: ${gameData.maxSlots}`);
        saveGame(false); // é—œéµæ“ä½œç«‹å³å­˜æª”
        updateUI();
      }
    }

    // åŸ·è¡Œè½‰è›‹
    function drawGacha(tierIndex) {
      if (gameData.pets.length >= gameData.maxSlots) {
        showMessage("ä½ç½®å·²æ»¿ï¼è«‹å…ˆæ“´å……æˆ–æ”¾ç”Ÿï¼");
        return;
      }

      let machine = GACHA_TIERS[tierIndex];
      if (gameData.money < machine.cost) {
        showMessage("é‡‘å¹£ä¸è¶³ï¼");
        return;
      }

      gameData.money -= machine.cost;

      // æ ¹æ“šæ©Ÿç‡è¡¨æ±ºå®šç¨€æœ‰åº¦
      let rand = Math.random();
      let odds = machine.odds;
      let rarity = "common";
      let acc = 0;

      // ä¾åºç´¯åŠ æ©Ÿç‡æª¢æŸ¥
      if (rand < odds.mythical) rarity = "mythical";
      else if (rand < odds.mythical + odds.legendary) rarity = "legendary";
      else if (rand < odds.mythical + odds.legendary + odds.epic) rarity = "epic";
      else if (rand < odds.mythical + odds.legendary + odds.epic + odds.rare) rarity = "rare";
      else rarity = "common";

      let name = PET_NAMES[Math.floor(Math.random() * PET_NAMES.length)];

      addPet(rarity, name);
      showMessage(`ç²å¾— [${RARITY_DATA[rarity].name}] ${name}!`);
      updateUI();
      checkAchievements();
      saveGame(false); // æŠ½è›‹å®Œç«‹å³å­˜æª”

      // é—œé–‰è¦–çª— (å¯é¸ï¼Œé€™è£¡ä¸é—œé–‰æ–¹ä¾¿é€£æŠ½)
      updateButtons(); // åˆ·æ–°æŒ‰éˆ•ç‹€æ…‹
    }

    function addPet(rarityKey, name, isFree = false) {
      let baseIncome = RARITY_DATA[rarityKey].multiplier * 5;
      let newPet = {
        id: Date.now() + Math.random(),
        name: name,
        rarity: rarityKey,
        level: 1,
        baseIncome: baseIncome,
        income: baseIncome,
        upgradeCost: baseIncome * 10
      };
      gameData.pets.push(newPet);

      if (!gameData.collection.includes(name)) {
        gameData.collection.push(name);
        renderGallery();
      }
      let rName = RARITY_DATA[rarityKey].name;
      if (!gameData.collection.includes(rName)) {
        gameData.collection.push(rName);
      }
    }

    function setUpgradeMode(mode) {
      upgradeMode = mode;
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`mode-${mode}`).classList.add('active');
      updateUI();
    }

    function upgradePet(petId) {
      let pet = gameData.pets.find(p => p.id === petId);
      if (!pet) return;

      let levelsToBuy = 0;
      let totalCost = 0;
      let tempMoney = gameData.money;
      let currentUpgradeCost = pet.upgradeCost;
      let currentLevel = pet.level;

      if (upgradeMode === 1) {
        if (tempMoney >= currentUpgradeCost) {
          levelsToBuy = 1;
          totalCost = currentUpgradeCost;
        }
      } else if (upgradeMode === 10) {
        for (let i = 0; i < 10; i++) {
          if (tempMoney >= currentUpgradeCost) {
            totalCost += currentUpgradeCost;
            tempMoney -= currentUpgradeCost;
            currentUpgradeCost = Math.floor(currentUpgradeCost * 1.3);
            levelsToBuy++;
          } else {
            break;
          }
        }
      } else if (upgradeMode === 'max') {
        while (tempMoney >= currentUpgradeCost && levelsToBuy < 1000) {
          totalCost += currentUpgradeCost;
          tempMoney -= currentUpgradeCost;
          currentUpgradeCost = Math.floor(currentUpgradeCost * 1.3);
          levelsToBuy++;
        }
      }

      if (levelsToBuy > 0) {
        gameData.money -= totalCost;
        // é‡æ–°è¨ˆç®—æœ€çµ‚æ•¸å€¼ (é¿å…ä¸­é–“èª¤å·®)
        for (let i = 0; i < levelsToBuy; i++) {
          pet.level++;
          pet.income = Math.floor(pet.baseIncome * pet.level * 1.1);
          pet.upgradeCost = Math.floor(pet.upgradeCost * 1.3);
        }
        createFloatingText(event.clientX, event.clientY, `Lv +${levelsToBuy}`);
        updateUI();
        saveGame(false); // å‡ç´šå®Œç«‹å³å­˜æª”
        checkAchievements();
      } else {
        showMessage("é‡‘å¹£ä¸è¶³ï¼");
      }
    }

    function deletePet(id) {
      let pet = gameData.pets.find(p => p.id === id);
      if (!pet) return;
      if (confirm(`æ”¾ç”Ÿ [${RARITY_DATA[pet.rarity].name}] ${pet.name}ï¼Ÿ`)) {
        gameData.pets = gameData.pets.filter(p => p.id !== id);
        updateUI();
        saveGame(false);
      }
    }

    function rebirth() {
      if (gameData.money < REBIRTH_THRESHOLD) return;
      let nextMulti = 1 + ((gameData.rebirthCount + 1) * 0.5);

      if (confirm(`ğŸŒ€ è½‰ç”Ÿç¢ºèª\nå€ç‡å°‡æå‡è‡³ x${nextMulti}\né‡‘éŒ¢ã€å¯µç‰©å°‡é‡ç½®\nåœ–é‘‘èˆ‡æˆå°±æœƒä¿ç•™`)) {
        gameData.rebirthCount++;
        gameData.moneyMultiplier = nextMulti;
        gameData.money = 0;
        gameData.pets = [];
        // æ¬„ä½èˆ‡æ“´å……è²»ç”¨ä¹Ÿé‡ç½®
        gameData.maxSlots = 5;
        gameData.slotCost = 500;

        addPet("common", "è½‰ç”Ÿå²èŠå§†", true);

        saveGame(true);
        updateUI();
        checkAchievements();
        showInfoModal("è½‰ç”ŸæˆåŠŸ", `æ‚¨çš„è³ºéŒ¢æ•ˆç‡æå‡è‡³ x${gameData.moneyMultiplier.toFixed(1)}ï¼`);
      }
    }

    // --- UI & æ¸²æŸ“ ---
    function renderGachaShop() {
      const container = document.getElementById('gacha-list-container');
      container.innerHTML = "";
      GACHA_TIERS.forEach((tier, index) => {
        let div = document.createElement('div');
        div.className = `gacha-item ${tier.class}`;
        div.innerHTML = `
                    <div class="gacha-info">
                        <h4>${tier.name}</h4>
                        <p>${tier.desc}</p>
                        <p style="font-size:0.75rem; color:#999;">æˆæœ¬: $${formatNumber(tier.cost)}</p>
                    </div>
                    <button class="gacha-buy-btn" id="btn-gacha-${index}" onclick="drawGacha(${index})">
                        æŠ½ç ($${formatNumber(tier.cost)})
                    </button>
                `;
        container.appendChild(div);
      });
    }

    function formatNumber(num) {
      if (num < 1000) return Math.floor(num);
      if (num < 1000000) return (num / 1000).toFixed(1) + 'k';
      if (num < 1000000000) return (num / 1000000).toFixed(2) + 'M';
      if (num < 1000000000000) return (num / 1000000000).toFixed(2) + 'B';
      return (num / 1000000000000).toFixed(2) + 'T';
    }

    function formatTime(seconds) {
      if (seconds < 60) return Math.floor(seconds) + "ç§’";
      let mins = Math.floor(seconds / 60);
      if (mins < 60) return mins + "åˆ†é˜";
      return Math.floor(mins / 60) + "å°æ™‚ " + (mins % 60) + "åˆ†é˜";
    }

    function updateHeader() {
      document.getElementById('money').innerText = '$' + formatNumber(gameData.money);
      document.getElementById('gps').innerText = '$' + formatNumber(calculateIncome()) + '/ç§’';
      document.getElementById('multiplier').innerText = 'x' + gameData.moneyMultiplier.toFixed(1);
      document.getElementById('click-val').innerText = formatNumber(Math.floor(10 * gameData.moneyMultiplier));

      let slotEl = document.getElementById('slots');
      slotEl.innerText = `${gameData.pets.length} / ${gameData.maxSlots}`;
      if (gameData.pets.length >= gameData.maxSlots) slotEl.classList.add('full-slots');
      else slotEl.classList.remove('full-slots');
    }

    function updateButtons() {
      // æ›´æ–°æ“´å……æŒ‰éˆ•
      const slotBtn = document.getElementById('slotBtn');
      document.getElementById('slot-cost-display').innerText = formatNumber(gameData.slotCost);
      slotBtn.disabled = gameData.money < gameData.slotCost;

      // æ›´æ–°è½‰ç”ŸæŒ‰éˆ•
      const rebirthBtn = document.getElementById('rebirthBtn');
      rebirthBtn.style.display = (gameData.money >= REBIRTH_THRESHOLD) ? "flex" : "none";

      // æ›´æ–°å•†åº—å…§çš„æŠ½çæŒ‰éˆ•ç‹€æ…‹
      if (document.getElementById('gacha-modal').style.display !== 'none') {
        const isFull = gameData.pets.length >= gameData.maxSlots;
        GACHA_TIERS.forEach((tier, index) => {
          let btn = document.getElementById(`btn-gacha-${index}`);
          if (btn) {
            if (isFull) {
              btn.disabled = true;
              btn.innerText = "ä½ç½®æ»¿";
            } else if (gameData.money < tier.cost) {
              btn.disabled = true;
              btn.innerText = "ç¼ºéŒ¢";
            } else {
              btn.disabled = false;
              btn.innerText = `æŠ½ç ($${formatNumber(tier.cost)})`;
            }
          }
        });
      }
    }

    function updateUI() {
      updateHeader();
      updateButtons();

      const list = document.getElementById('pet-list');
      list.innerHTML = "";

      let sortedPets = [...gameData.pets].sort((a, b) => {
        const priority = {
          mythical: 5,
          legendary: 4,
          epic: 3,
          rare: 2,
          common: 1
        };
        return (priority[b.rarity] - priority[a.rarity]) || (b.income - a.income);
      });

      sortedPets.forEach(pet => {
        let rarityInfo = RARITY_DATA[pet.rarity];
        let currentIncome = Math.floor(pet.income * gameData.moneyMultiplier);

        let btnText = (upgradeMode === 'max') ? "MAX å‡ç´š" : (upgradeMode === 10 ? "å‡10ç´š" : `å‡ç´š ($${formatNumber(pet.upgradeCost)})`);

        let card = document.createElement('div');
        card.className = `pet-card ${rarityInfo.color}`;
        card.innerHTML = `
                    <button class="btn-delete-pet" onclick="deletePet(${pet.id})" title="æ”¾ç”Ÿ">âœ–</button>
                    <div class="pet-rarity">${rarityInfo.name}</div>
                    <div class="pet-icon">${getIconByRarity(pet.rarity)}</div>
                    <div class="pet-name">${pet.name}</div>
                    <div class="pet-stats">Lv.${pet.level}</div>
                    <div class="pet-stats" style="color:#27ae60; font-weight:bold;">+$${formatNumber(currentIncome)}/ç§’</div>
                    <button class="btn-upgrade" onclick="upgradePet(${pet.id})">${btnText}</button>
                `;
        list.appendChild(card);
      });
    }

    // --- æ¨¡æ…‹è¦–çª—èˆ‡åœ–é‘‘ ---
    function openModal(id) {
      document.getElementById(id).style.display = 'flex';
      updateButtons();
    }

    function closeModal(e, id) {
      if (e.target.id === id) {
        document.getElementById(id).style.display = 'none';
      }
    }

    function showInfoModal(title, desc) {
      document.getElementById('info-title').innerText = title;
      document.getElementById('info-desc').innerHTML = desc;
      document.getElementById('info-modal').style.display = 'flex';
    }

    function renderGallery() {
      const grid = document.getElementById('gallery-grid');
      grid.innerHTML = "";
      PET_NAMES.forEach(name => {
        let isCollected = gameData.collection.includes(name);
        let div = document.createElement('div');
        div.className = `gallery-item ${isCollected ? 'collected' : ''}`;
        div.innerHTML = `
                    <div class="g-icon">${isCollected ? 'ğŸ¾' : '?'}</div>
                    <div class="g-name">${name}</div>
                `;
        grid.appendChild(div);
      });
    }

    function renderAchievements() {
      const list = document.getElementById('ach-list');
      list.innerHTML = '';
      let unlockedCount = 0;
      ACHIEVEMENTS.forEach(ach => {
        const isUnlocked = gameData.unlockedAchievements.includes(ach.id);
        if (isUnlocked) unlockedCount++;
        const item = document.createElement('div');
        item.style.cssText = `background: ${isUnlocked?'#fff3cd':'#eee'}; margin-bottom:10px; padding:10px; border-radius:8px; display:flex; align-items:center; gap:10px; opacity:${isUnlocked?1:0.6}; border: ${isUnlocked?'2px solid #ffc107':'none'}`;
        item.innerHTML = `
                    <div style="font-size:1.5rem">${ach.icon}</div>
                    <div style="flex:1"><h4 style="margin:0">${ach.title}</h4><p style="margin:0; font-size:0.8rem; color:#666">${ach.desc}</p></div>
                    <div style="font-size:1.2rem">${isUnlocked ? 'âœ…' : 'ğŸ”’'}</div>
                `;
        list.appendChild(item);
      });
      document.getElementById('ach-badge').innerText = `${unlockedCount}/${ACHIEVEMENTS.length}`;
      document.getElementById('ach-progress-bar').style.width = `${(unlockedCount / ACHIEVEMENTS.length) * 100}%`;
    }

    function checkAchievements() {
      let newlyUnlocked = false;
      ACHIEVEMENTS.forEach(ach => {
        if (!gameData.unlockedAchievements.includes(ach.id)) {
          if (ach.check(gameData)) {
            gameData.unlockedAchievements.push(ach.id);
            showMessage(`ğŸ† è§£é–æˆå°±ï¼š${ach.title}`);
            newlyUnlocked = true;
          }
        }
      });
      if (newlyUnlocked) {
        saveGame(true); // æˆå°±è§£é–ä¹Ÿè¦å­˜æª”
        renderAchievements();
        if (gameData.unlockedAchievements.length === ACHIEVEMENTS.length && !gameData.hasWon) {
          gameData.hasWon = true;
          showInfoModal("ğŸ‰ æ­å–œå®Œå…¨é€šé—œï¼", "æ‚¨å·²æˆç‚ºçœŸæ­£çš„å¤¢å¹»å¯µç‰©å¤§å¸«ï¼");
        }
      }
    }

    function getIconByRarity(rarity) {
      switch (rarity) {
        case 'common':
          return 'ğŸ®';
        case 'rare':
          return 'ğŸº';
        case 'epic':
          return 'ğŸ¦„';
        case 'legendary':
          return 'ğŸ²';
        case 'mythical':
          return 'ğŸ‘¹';
        default:
          return 'ğŸ¥š';
      }
    }

    function createFloatingText(x, y, text) {
      let el = document.createElement('div');
      el.innerText = text;
      el.style.cssText = `position:fixed; left:${x}px; top:${y}px; color:#27ae60; font-weight:bold; pointer-events:none; transition:all 0.8s; z-index:4000; font-size:1.2rem; text-shadow: 1px 1px 0 #fff;`;
      document.body.appendChild(el);
      setTimeout(() => {
        el.style.top = (y - 50) + 'px';
        el.style.opacity = 0;
      }, 50);
      setTimeout(() => {
        el.remove();
      }, 800);
    }

    function showMessage(msg) {
      let area = document.getElementById('message-area');
      area.innerText = msg;
      area.classList.add('show-message');
      setTimeout(() => {
        area.classList.remove('show-message');
      }, 2000);
    }

    // â˜…â˜…â˜… å³æ™‚å­˜æª”é‚è¼¯ â˜…â˜…â˜…
    function saveGame(showToast = false) {
      gameData.lastLoginTime = Date.now();
      localStorage.setItem('petTycoonSave_v7', JSON.stringify(gameData));

      if (showToast) {
        let toast = document.getElementById('save-toast');
        toast.classList.add('show-save');
        setTimeout(() => {
          toast.classList.remove('show-save');
        }, 1500);
      }
    }

    function loadGame() {
      let save = localStorage.getItem('petTycoonSave_v7');
      if (!save) save = localStorage.getItem('petTycoonSave_v6');

      if (save) {
        try {
          let parsed = JSON.parse(save);
          gameData = { ...gameData,
            ...parsed
          };
        } catch (e) {}
      }
    }

    function hardReset() {
      if (confirm("ğŸ”¥ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰é€²åº¦ï¼ˆåŒ…æ‹¬åœ–é‘‘èˆ‡æˆå°±ï¼‰ä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šå—ï¼Ÿ")) {
        localStorage.removeItem('petTycoonSave_v7');
        location.reload();
      }
    }

    init();
  </script>
</body>

</html>